# ngx\_header\_path\_auth

nginxのauth request moduleへ、ヘッダーに設定したユーザ名とパス情報を元にした認可を提供するモジュールです。

## エラー処理

エラー時は、プロセスが異常ステータスで終了します。 

## 実行方法

コマンドラインは、以下の通りです。

```
ngx_header_path_auth 設定ファイル名
```

自前ではdaemon化等のバックグラウンド実行の機能は提供しません。  
systemd等のプロセス管理のシステムから起動してください。


## 設定ファイル書式

nginx側の設定方法については、[auth request moduleのドキュメント](http://nginx.org/en/docs/http/ngx_http_auth_request_module.html)を参照してください。

ngx_header_path_autuの設定ファイルは、TOMLフォーマットで、以下がサンプルです。

```ini
socket_type = "tcp"
socket_path = "127.0.0.1:9202"
path_header = "X-Authz-Path"
user_header = "X-Forwarded-User"

[authz]
user_map = "/etc/ngx_auth_mod/usermap.conf"

path_pattern = "^/([^/]+)/"
nomatch_right = "@admin"
default_right = "*/

[authz.path_right]
"test" = "@dev"
```

設定ファイルの各パラメータの意味は以下のとおりです。

* **socket\_type** - tcp(TCPソケット)とunix(Unixドメインソケット)が指定できます。
* **socket\_path** - tcpの場合はIPアドレスとポート番号、unixの場合はソケットファイルのファイルパスを指定します。
* **path\_header** - 認可処理の使うパスを設定するHTTPヘッダーです。デフォルト値は`X-Authz-Path`です。nginxの設定ファイルの適切な箇所で、`proxy_set_header X-Authz-Path $request_uri;`などのように、ヘッダーの値を設定してください。
* **user\_header** - ユーザ名を設定するHTTPヘッダーです。デフォルト値は`X-Forwarded-User`です。nginxの設定ファイルの適切な箇所で、`proxy_set_header X-Forwarded-User $remote_user;`などのように、ヘッダーの値を設定してください。

* \[authz\]部分
  * **user_map** - ユーザ名とグループ名のマッピングファイルです。ファイルの書式は別途説明します。
  * **path\_pattern** - **path_header**のヘッダで渡されたパス情報から**path\_right**で指定したパスごとの認可権限の判定を行う文字列を抽出する正規表現です。`()`の正規表現を１つだけ使って、認可権限の判断に使う文字列部分を指定してください。
  * **nomatch\_right** - **path\_pattern**の正規表現のマッチが失敗した場合の認可権限の設定です。認可権限の書き方は、詳しくは「認可権限の詳細」の説明を見てください。
  * **default\_right** - **path\_pattern**の正規表現のマッチが成功し、かつ、**path\_right**に正規表現で抽出された文字列がマッチしない場合の、認可権限の設定です。認可権限の書き方は、詳しくは「認可権限の詳細」の説明を見てください。
  * **path\_right** - **path\_pattern**の正規表現のマッチに成功したときの、パスごとの認可権限の設定です。正規表現で抽出された文字列をキーとして認可権限を指定します。個々の認可権限の書き方は、詳しくは「認可権限の詳細」の説明を見てください。

## 認可権限の詳細
\[authz\]の**nomatch\_right**、**default\_right**、**path\_right**のテーブルの各要素の値は、以下の判定処理の記述を|で結合した文字列を指定します。結合した判定処理は倫理和(or)>で処理されます。判定結果が正常にならない場合は、スクリプトは実行されません。

* '' - (空文字) ユーザー名に関係なく正常と判断します。
* '!' - ユーザ名に関係なく異常と判断します。
* '*' ユーザ名が正常なものであれば、正常と判断します。
* '@グループ名` - @の後ろのグループ名のグループに利用者のユーザ名が含まれる場合に正常と判断します。グループは**user_map**パラメータのファイルで定義します
* '@' - (@のみ、グループ名無し) **user_map**に利用者のユーザ名が記述されていれば、正常と判断します。
* 'ユーザ名` - 利用者のユーザ名と一致する場合に正常と判断します。

## **user\_map**の詳細
**user\_map**で指定されたファイルで、ユーザ名とグループ名のマッピングを行います。  
このファイルはテキストファイルで、各行にユーザ名とその所属するグループ名(無し及び複数も可)を記述こと>で、ユーザ名とグループ名のマッピングを表現します。

各行は以下のような書式になります。

``` plaintext
ユーザ名1:グループ名1 グループ名2 ...
```

ユーザ名とグループ名の間は`:`で区切ります。グループ名が複数の倍は` `(空白文字)で区切ります。
